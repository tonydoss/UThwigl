---
title: "iDADwigl - a R package for open-system uranium-thorium dating"
author: "Anthony Dosseto$^1$$^,$$^*$ and Ben Marwick$^2$"
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    fig_caption: yes
    includes:
      in_header: mystyles.sty
    keep_tex: no
    latex_engine: xelatex
    number_sections: no
    toc: FALSE
linestretch: 1.5
csl: geochimica-et-cosmochimica-acta.csl
bibliography: Library.bib
vignette: >
  %\VignetteIndexEntry{iDADwigl - a R package for open-system uranium-thorium dating}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = TRUE, 
               warning = FALSE, 
               message = FALSE,
               fig.pos="H")
# knitr::write_bib(x = "rmarkdown", file = "Library.bib") # so you can cite references in figure captions
```

$^1$Wollongong Isotope Geochronology Laboratory, School of Earth & Envrionmental Sciences. University of Wollongong. Wollongong NSW Australia

$^2$Department of Anthropology, University of Washington, Seattle, WA, USA

$^*$Corresponding author: tonyd@uow.edu.au

\newpage
\linenumbers

# Introduction

Open-system uranium-thorium (U-Th) dating of teeth and bones, while challenging, has revolutionised our ability to provide reliable chronology for humans and fauna [@Eggins2005; @Gruen2014; @Sambridge2012]. Thus, this approach has significantly improved our understanding of human evolution [e.g. @Dirks2017; @Sutikna2016]. Uranium-thorium dating is based on the premise that a material takes up U but no Th, so all the ^230^Th in the sample comes from decay of ^238^U. If detrital Th is included to the sample, a correction must be included to account for the fraction of ^230^Th which is detrital and not derived from ^238^U decay. Another requirement is that there is no gain or loss of ^230^Th, ^234^U or ^238^U after formation of the material. While it is often the case for many geological samples such as corals or speleothems, this requirement is rarely met for teeth and bone (although enamel can sometimes be quite impervious to isotope gain or loss). Thus, for teeth and bone, U-Th dating requires to take into account open system behaviour. The diffusion-adsorption-decay (DAD) model developed by Sambridge et al. [-@Sambridge2012] was instrumental to implement successfully open-system U-Th dating. It allows for advective and diffusive transport of uranium and thorium isotopes, while include synchronous radioactive decay. The software implementation was written in Fortran and is available as a Java GUI (<http://www.iearth.org.au/codes/iDaD/>). In this article, we propose a R package which implements the model of Sambridge et al. [-@Sambridge2012].

The motivation for providing this model as an R package is to increase the transparency, reproducibility, and flexibility of the analytical workflow for computing U-Th ages. Currently it is difficult to include the Java GUI in a fully scripted data analysis so the method for computing the DAD model is not highly transparent. This can obscure steps where key decisions are made that are important for others to see to verify the reliability of the analysis. Enabling a scripted workflow for computational analysis of geoscience data is important for improving the reproducibiltiy of results. Reproducibility refers the ability to recreate the results or retest the hypotheses leading to a scientific claim, either by rerunning the same code used by the original authors, or by writing new code. High rates of irreproducibility of research results have been estimated in several fields and disciplines [@academy2015reproducibility; @freedman2015economics; @global2013case;  @ioannidis2005most; @open2015estimating; @camerer2018evaluating; @Camerer1433]. Consequently, the transparency, openness, and reproducibility of results and methods are receiving increased attention, and the norms of research in many fields are changing [@nosek2015promoting; @miguel2014promoting]. 

There is strong interest in open, transparent, and reusable research in the geoscience community [@Gil_et_al_2016] and substantial progress toward open data has been made in the geosciences with the widespread use of data services of NASA, USGS, NOAA and community-built data portals such as OneGeology, EarthChem, RRUFF, PANGAEA, PaleoBioDB, and others [@Kattge_DÃ­az_Wirth_2014; @ma2018data]. However, the use of open source software such as R [@Pebesma_Nust_Bivand_2012], and sharing of scripted data analysis workflows with research publications is not yet widespread [@Hutton_et_al_2016]. With this R package our goal is to make scripted and reproducible data analysis easy for open-system uranium-thorium dating. This will improve the transparency of geochronology research, and provide a more credible and robust foundation for scientific advancement [@Hutton_et_al_2016].

# Methods

Data required for the DAD model are (^230^Th/^238^U) and (^234^U/^238^U) activity ratios collected along a transect perpendicular to the surface of the tooth or bone (brackets denote activity ratios throughout this article). Sampling for analysis can be done by micro-drilling or laser ablation. If the former, aliquots are then dissolved, followed by separation of U and Th using ion exchange chromatography. This is more time consuming (at least one week of work) than laser ablation, where the material sampled by the laser is directly sent to the mass spectrometer. 

While laser ablation also offers a better spatial resolution than micro-drilling, the precision of the data is inferior because of the much smaller amount of material sampled. Uranium and thorium isotope ratios are then analysed by multi-collector inductively-coupled plasma mass spectrometry. A plasma ionise all U and Th atoms, their isotopes are separated through a magnetic field and each collected in a different collector. If using laser ablation, it is best to have two ion counters so ^230^Th and ^234^U can be collected simultaneously.

The distance of each analysis location from the inner and outer surfaces of the bones, for instance, needs to be recorded. One surface is given a coordinate of 1 and the other one -1, thus coordinates of analyses take values in between (Figure \@ref(fig:femurpic)).

# Input data format

The key function of our package, `iDADwigl()` requires a data frame with the following column names: 

- `iDAD.position`
- `U234_U238_CORR`
- `U234_U238_CORR_Int2SE`
- `iDAD.position.1`
- `Th230_U238_CORR`
- `Th230_U238_CORR_Int2SE`
- `U_ppm`
- `U_ppm_Int2SE`        

This data frame can be created by importing an Excel or CSV file into the R environment using a generic function such as `read.csv` or `read_excel` from the `readxl` package [@Wickham_readxl]. To help with preparing data for input into our function, we have included two examples of input files. The code chunk below shows how to access one of the two example CSV files included in the package, and how to read it into the R environment.


```{r}
# get the path the one of the CSV files included in the package
path_to_included_example_csv_file <- 
  system.file("extdata", 
            "input/Hobbit_MH2T_for_iDAD.csv", 
            package = "OpenSystemUThDating",
            mustWork = TRUE)

# read in the example CSV file included in the package
Hobbit_MH2T_for_iDAD <- 
  read.csv(path_to_included_example_csv_file)
```

\newpage

Table \@ref(tab:hobbitone) shows the data contained in the `Hobbit_MH2T_for_iDAD.csv` file included in the package

```{r hobbitone, results="asis", echo = FALSE}
# inspect the data frame produced by importing the CSV file
library(dplyr)
library(xtable)
options(xtable.floating = TRUE,
        xtable.comment = FALSE)

Hobbit_MH2T_for_iDAD_tbl <- 
Hobbit_MH2T_for_iDAD %>% 
  xtable(
         digits = c(1,7,7,5,7,7,5,1,3),
         caption = "\\label{tab:hobbitone}Data contained in the example CSV file Hobbit\\_MH2T\\_for\\_iDAD.csv included in the package") 

align(Hobbit_MH2T_for_iDAD_tbl) <- rep("c", ncol(Hobbit_MH2T_for_iDAD_tbl) + 1)
  
print(Hobbit_MH2T_for_iDAD_tbl,
        method = 'compact',
        include.rownames = FALSE,
        rotate.colnames = TRUE)
```

The columns `iDAD.position`, `U234_U238_CORR`, `U234_U238_CORR_Int2SE`, `Th230_U238_CORR` and `Th230_U238_CORR_Int2SE` must be present in the input data frame with these exact names for the model to function. The `iDADwigl()` function will check if the input data frame has these columns, and will stop with an error message if it does not find these columns. The `names` function can be used to update column names of a data frame to ensure they match the names that the model function requires. The order of the columns in the data frame is not important. 

The `iDAD.position` column corresponds to the coordinates of the (^234^U/^238^U) analyses, which as indicated above take values between -1 and 1 (Figure \@ref(fig:femurpic)). The second `iDAD.position.1` column is used if the coordinates of the (^230^Th/^238^U) analyses are different from those of the (^234^U/^238^U) analyses. 

Columns `U234_U238_CORR` and `U234_U238_CORR_Int2SE` are the (^234^U/^238^U) activity ratios and their 2$\sigma$ errors. Columns `Th230_U238_CORR` and `Th230_U238_CORR_Int2SE` are the (^230^Th/^238^U) activity ratios and their 2$\sigma$ errors. 

Columns `U_ppm` and `U_ppm_Int2SE` and calculated uranium concentrations (in ppm) and their 2$\sigma$ errors. Uranium concentrations are not necessary for the model and only used for display of the U concentration profile in a figure.

(ref:femurpiccap) Modern human femur (132A/LB/27D/03) from Liang Bua, Flores, Indonesia. Two analysis transects can be seen. For a given transect, the outer and inner surface of the bone are given 1 and -1 reference coordinates, and the position of each analysis is calculated accordingly. Modified from Sutikna et al. [-@Sutikna2016]

```{r femurpic, out.width = "75%", fig.cap="(ref:femurpiccap)", echo = FALSE}
include_graphics("figures/bone.png")
```

\newpage

# Details of the input parameters

Our key function, `iDADwigl()` has several arguments that need to be set before we can get meaningful results.

`nbit` is the number of iterations. For the first run, set to 1.

`fsum_target` is the sum of the squared differences between the calculated and observed activity ratios. Give it a low value to start with (e.g. 0.05). If script takes too long, try a higher value for fsum_target.

`U48_0_min` and `U48_0_max` are the minimum and maximum values allowed for the (^234^U/^238^U) activity ratio at the surface of the sample. Since (^234^U/^238^U) does not vary greatly over the time period generally studied, the values measured near the surface of the sample can be used as a guide. These values can be adjusted if the model fit to the data is not optimal. For Hobbit_1-1T it is 1.3 and 1.4, and for Hobbit_MH2T it is 1.265 and 1.275.

`l` is the thickness of the sample in centimeters. For Hobbit_1-1T it is 3.5 cm, for Hobbit_MH2T it is 5.35 cm

`U_0` is the Uranium concentration at the surface in ppm. This value does not significantly affect the model results and values from analyses near either surface of the sample can be used as a guide. For Hobbit_1-1T it is 15 ppm; Hobbit_MH2T is 25 ppm.

`K_min` and `K_max` are the minimum and maximum values allowed for the uranium diffusion coefficient (in cm^2^/s). Values between 10^-13^ and 10^-11^ cm^2^/s are generally appropriate.

`T_min` and `T_max` are the minimum and maximum values for the age of the specimen (yr). If there is no estimated knowledge of the sample age, the range of values can be 1,000 to 500,000 yr and adjusted later. For Hobbit_1-1T it is 50e3 and 100e3, and for Hobbit_MH2T it is 1e3 and 20e3.

After setting the `U480` maximum and minimum values, run the function and adjust these min and max values by looking at the calculated `U48_0_final`, `K_final`, and `T_final`. As you iterate, increase the `nbit` value to reduce the error.

# How to run the model

To run the model, start `R` and install the package from GitHub. There are many ways to do this, one simple method is shown in the line below. This only needs to be done once per computer.

```{r eval = FALSE}
source("https://install-github.me/tonydoss/iDADwigl")
```

To run the function, attach the package and then run `iDADwigl()`, specifying the input data frame and the input parameters as described above. The code block below shows a quick example that will execute in less than five seconds on a typical 2.3 GHz Intel Core i5 laptop:  

```{r results='hide'}
library(OpenSystemUThDating)
output <- iDADwigl(Hobbit_MH2T_for_iDAD,
                   nbit = 500,
                   fsum_target = 0.01,
                   U48_0_min = 1.265, 
                   U48_0_max = 1.275, 
                   l = 5.35, 
                   U_0 = 25, 
                   K_min = 1e-13,
                   K_max = 1e-11,
                   T_min = 1e3, 
                   T_max = 20e3)
```

When run the R console, this function will print a confirmation that the input data frame has the required columns, and print the resulting age value with an error reported as the 67% and 33% quantiles, as follows:

```
All required columns are present in the input data ðŸ‘
[1] "Age: 7 +0.6/-0.7 ka"
```

In a typical analysis we will explore the model fit by changing the range of allowed values for the (^234^U/^238^U) ratio at the surface and the age of the sample, and by decreasing the `fsum_target`. Once we obtain a satisfying fit (by visual inspection of the produced figures), we would increase `nbit` to a higher value (e.g. 1000) and run the model again.

## Inspecting the model's output

The function also produces a list object containing more detailed results, including a one-row data frame summarising the age:  

```{r outputresults, results="asis", echo = FALSE}
options(xtable.floating = TRUE,
        xtable.comment = FALSE)

output_results_table <- 
output$results %>% 
  xtable(
         digits = rep(6, ncol(output$results)+1),
         caption = "\\label{tab:outputresults}Summary table of the computed age and error values") 

align(output_results_table) <- rep("c", ncol(output_results_table) + 1)
  
print(output_results_table, 
      method = 'compact',
      include.rownames = FALSE,
      rotate.colnames = TRUE)
```

The output also includes the calculated `T_final`, `K_final`, and `U48_0_final values

<!-- what are these, and what should the user be looking for with these? I think we need some more explanation, and I have no idea! -->

The last item in the output is a copy of the input data with two additional columns, the calculated activity ratios, ^234^U/^238^U and ^230^Th/^238^U, for each measurement location on the sample. 

```{r outputdata, results="asis", echo = FALSE}
options(xtable.floating = TRUE,
        xtable.comment = FALSE)

output_data_table <- 
output$output_data %>% 
  xtable(
         digits = c(1,6,6,5,7,4,6,1,3,6,7),
         caption = "\\label{tab:outputdata}Output table including the input data and two new columns") 

align(output_data_table) <- rep("c", ncol(output_data_table) + 1)
  
print(output_data_table, 
      method = 'compact',
      include.rownames = FALSE,
      rotate.colnames = TRUE)
```

## Visualising the model's output

We can make some plots... <!-- I'll combine these into a multipanel plot-->

```{r echo=FALSE}
library(ggplot2)
theme_plots <-
  theme(
    plot.title = element_text(size = (18), hjust = 0.5),
    legend.title = element_blank(),
    axis.title.y = element_text(size = 18),
    axis.title.x = element_text(size = 18),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)
  ) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

This is a plot of ... which is useful for ... (Figure \@ref(fig:tsol))

```{r tsol, echo=FALSE, fig.cap="A tsol plot"}
 

 library(ggplot2)


ggplot(output$T_sol, 
       aes(T_sol)) + 
  geom_histogram(binwidth = 500,
                 fill = "white",
                 color = "black") + 
  theme_plots
```


This is a plot of ... which is useful for ... (Figure \@ref(fig:th230-u238))


```{r th230u238, echo=FALSE, fig.cap="A th230u238 plot" }
ggplot(output$output_data) +
  geom_errorbar(
    aes(
      x = iDAD.position,
      ymax = Th230_U238_CORR + Th230_U238_CORR_Int2SE,
      ymin = Th230_U238_CORR - Th230_U238_CORR_Int2SE,
      width = 0.02
    )
  ) + # plot error bars
  geom_point(aes(iDAD.position, Th230_U238_CORR),
             color = 'blue',
             size = 5) +
  geom_point(aes(iDAD.position, Th230_U238_CALC),
             color = 'red',
             size = 5) +
  ylab(expression("(" ^ 230 * "Th/" ^ 238 * "U)")) + xlab("Relative distance from center") +
  theme_plots + ggtitle(paste(
    "Age: ",
    round(output$T_final / 1000, digits = 1),
    " +",
    round((quantile(output$T_sol$T_sol, .67) - output$T_final) / 1000, digits = 1),
    "/-",
    round((output$T_final - quantile(output$T_sol$T_sol, .33)) / 1000, digits = 1),
    " ka",
    sep = ""
  ))
```


```{r}
ggplot(output$output_data) +
  geom_errorbar(
    aes(
      x = iDAD.position,
      ymax = U_ppm + U_ppm_Int2SE,
      ymin = U_ppm - U_ppm_Int2SE,
      width = 0.02
    )
  ) + # plot error bars
  geom_point(aes(iDAD.position, U_ppm), color = 'blue', size = 5) +
  ylab("U (ppm)") + xlab("Relative distance from center") +
  theme_plots
```

```{r}
ggplot(output$output_data) +
  geom_errorbar(
    aes(
      x = iDAD.position,
      ymax = U234_U238_CORR + U234_U238_CORR_Int2SE,
      ymin = U234_U238_CORR - U234_U238_CORR_Int2SE,
      width = 0.02
    )
  ) + # plot error bars
  geom_point(aes(iDAD.position, U234_U238_CORR),
             color = 'blue',
             size = 5) +
  geom_point(aes(iDAD.position, U234_U238_CALC ),
             color = 'red',
             size = 5) +
  ylab(expression("(" ^ 234 * "U/" ^ 238 * "U)")) + xlab("Relative distance from center") +
  theme_plots + ggtitle(paste(
    "Age: ",
    round(output$T_final / 1000, digits = 1),
    " +",
    round((quantile(output$T_sol$T_sol, .67) - output$T_final) / 1000, digits = 1),
    "/-",
    round((output$T_final - quantile(output$T_sol$T_sol, .33)) / 1000, digits = 1),
    " ka",
    sep = ""
  ))

```




# Case study of the age of the Hobbit from Sutikna et al. 2016


The package includes two sample data sets derived from @Sutikna2016 : "Hobbit_MH2T_for_iDAD.csv" is data from transect 2 for modern human femur 132A/LB/27D/03. "Hobbit_1-1T_for_iDAD.csv" is data from transect 1 for *Homo floresiensis* ulna LB1/52. For the latter, six analyses were removed from the set as in @Sutikna2016.

```{r}
kableExtra::kable(Hobbit_MH2T_for_iDAD[ , 1:4],
                  caption = "Preview of the data from transect 2 for modern human femur 132A/LB/27D/03, included in our R package.")
```

```{r}
kableExtra::kable(Hobbit_1_1T_for_iDAD[ , 1:4],
                  caption = "Preview of the data from transect 1 for Homo floresiensis ulna LB1/52, included in our R package.")
```

For transect 2 of 132A/LB/27D/03, Sutikna et al. [-@Sutikna2016] reported an age of 7.4 $\pm$ 0.5 ka (thousand years before 2014). With iDADwigl, we obtain an age of 7.1 +0.6/-0.7 ka (Figs. 2-4). We obtained our age for


For transect 1 of LB1/52, Sutikna et al. [-@Sutikna2016] reported an age of 79.0 $\pm$ 3.7 ka. With iDADwigl, we obtain an age of 75.4 $\pm$ 0.9 ka.

![Uranium concentration profile for transect 2 of modern human femur 132A/LB/27D/03](figures/U_Hobbit_MH2T_DAD.png)

![Calculated (red) and observed (blue) (^234^U/^238^U) activity ratios for transect 2 of modern human femur 132A/LB/27D/03.](figures/R48_Hobbit_MH2T_DAD.png)

![Calculated (red) and observed (blue) (^230^Th/^238^U) activity ratios for transect 2 of modern human femur 132A/LB/27D/03](figures/R08_Hobbit_MH2T_DAD.png)


\newpage
\nolinenumbers
# References
